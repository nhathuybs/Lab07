<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POI Finder VN – Tích hợp Dịch thuật + Firebase Auth</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    #map { height: 65vh; }

    /* Animation cho Popup Dịch thuật */
    #translatePopup {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: bottom left;
    }
    .popup-hidden {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
      pointer-events: none;
    }
    .popup-visible {
      opacity: 1;
      transform: scale(1) translateY(0);
      pointer-events: auto;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 relative min-h-screen">

  <header class="max-w-5xl mx-auto p-4">
    <div class="flex flex-col md:flex-row justify-between md:items-center gap-2">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-indigo-900">POI Finder VN</h1>
        <p class="text-sm text-slate-600">Tìm địa điểm, xem thời tiết & tra cứu từ vựng.</p>
      </div>

      <!-- (Tuỳ chọn) Chỗ hiển thị user nhỏ ở header -->
      <div class="text-sm text-slate-600">
        <span class="inline-flex items-center gap-2 bg-white border border-slate-200 rounded-full px-3 py-1 shadow-sm">
          <i class="fa-solid fa-user text-indigo-500"></i>
          <span id="headerUserLabel">Chưa đăng nhập</span>
        </span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4 space-y-4 pb-24">

    <!-- =========================
      0) FIREBASE AUTH UI (MỚI)
    ========================== -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 md:p-6">
      <h2 class="font-bold text-indigo-900 flex items-center gap-2">
        <i class="fa-solid fa-user-lock text-indigo-500"></i> Tài khoản (Firebase Authentication)
      </h2>

      <!-- Logged out -->
      <div id="authLoggedOut" class="mt-4 space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
          <div class="md:col-span-2">
            <label for="authEmail" class="text-sm font-medium text-slate-700">Email</label>
            <input id="authEmail" type="email"
              class="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50"
              placeholder="name@example.com" />
          </div>

          <div class="md:col-span-2">
            <label for="authPass" class="text-sm font-medium text-slate-700">Mật khẩu</label>
            <input id="authPass" type="password"
              class="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50"
              placeholder="Tối thiểu 6 ký tự" />
          </div>

          <div class="md:col-span-2 flex gap-2">
            <button id="loginBtn"
              class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 font-semibold transition-all shadow-md active:scale-95">
              <i class="fa-solid fa-right-to-bracket mr-1"></i> Đăng nhập
            </button>
            <button id="signupBtn"
              class="w-full rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 font-semibold transition-all shadow-md active:scale-95">
              <i class="fa-solid fa-user-plus mr-1"></i> Đăng ký
            </button>
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-2 md:items-center">
          <!-- (Tuỳ chọn) Google Sign-in -->
          <button id="googleBtn"
            class="rounded-xl bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 text-sm font-semibold transition-all shadow-sm inline-flex items-center justify-center gap-2">
            <i class="fa-brands fa-google"></i> Đăng nhập Google
          </button>

          <button id="resetBtn"
            class="rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 text-sm font-semibold transition-all shadow-sm inline-flex items-center justify-center gap-2">
            <i class="fa-solid fa-key"></i> Quên mật khẩu
          </button>

          <span class="text-xs text-slate-400">
            *Google là tuỳ chọn (bật provider Google trong Firebase Console nếu dùng)
          </span>
        </div>

        <p id="authStatusOut" class="text-sm text-slate-500 italic"></p>
      </div>

      <!-- Logged in -->
      <div id="authLoggedIn" class="mt-4 hidden space-y-3">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="text-sm text-slate-500">Đang đăng nhập:</div>
            <div class="font-semibold text-indigo-700" id="userEmailLabel">...</div>
            <div class="text-xs text-slate-500" id="emailVerifiedLabel">...</div>
          </div>

          <div class="flex gap-2">
            <button id="verifyBtn"
              class="rounded-xl bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-4 py-2 text-sm font-semibold transition-all shadow-sm inline-flex items-center gap-2">
              <i class="fa-solid fa-envelope-circle-check"></i> Gửi email xác minh
            </button>

            <button id="logoutBtn"
              class="rounded-xl bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 text-sm font-semibold transition-all shadow-sm inline-flex items-center gap-2">
              <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
            </button>
          </div>
        </div>

        <p id="authStatusIn" class="text-sm text-slate-500 italic"></p>
      </div>
    </div>

    <!-- =========================
      1) SEARCH UI (CŨ, nhưng ban đầu bị khoá cho tới khi đăng nhập)
    ========================== -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 md:p-6 flex flex-col gap-3">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
        <div class="md:col-span-4">
          <label for="place" class="text-sm font-medium text-slate-700">Địa điểm</label>
          <input id="place" type="text" disabled
            class="mt-1 w-full rounded-xl border border-slate-200 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
            placeholder="Nhập tên địa điểm (VD: Hồ Gươm)..." />
        </div>

        <div class="md:col-span-1">
          <label for="radius" class="text-sm font-medium text-slate-700">Bán kính (m)</label>
          <select id="radius" disabled
            class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
            <option value="800">800</option>
            <option value="1200" selected>1200</option>
            <option value="1600">1600</option>
            <option value="2000">2000</option>
          </select>
        </div>

        <div class="md:col-span-1">
          <button id="searchBtn" disabled
            class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 font-semibold transition-all shadow-md active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fa-solid fa-search mr-1"></i> Tìm
          </button>
        </div>
      </div>

      <p id="status" class="text-sm text-slate-500 pl-1 italic">
        Vui lòng đăng nhập để sử dụng chức năng tìm POI.
      </p>
    </div>

    <div id="map" class="rounded-2xl shadow-md border border-slate-200 z-0"></div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
      <h2 class="font-bold mb-3 text-indigo-900 flex items-center gap-2">
        <i class="fa-solid fa-location-dot text-indigo-500"></i> 5 Địa điểm lân cận
      </h2>
      <ol id="poiList" class="list-decimal pl-6 space-y-2 text-sm text-slate-700"></ol>
    </div>

    <p class="text-xs text-slate-400 text-center pt-4">Dữ liệu: © OpenStreetMap, OpenWeatherMap, MyMemory API.</p>
  </main>

  <!-- =========================
    2) TRANSLATE POPUP (CŨ)
  ========================== -->
  <div id="translatePopup"
    class="fixed bottom-20 left-4 z-50 w-80 bg-white rounded-2xl shadow-2xl border border-indigo-100 p-4 popup-hidden">
    <div class="flex justify-between items-center mb-3">
      <h3 class="font-bold text-indigo-800 flex items-center gap-2">
        <i class="fa-solid fa-language"></i> Dịch Nhanh (Anh → Việt)
      </h3>
      <button onclick="toggleTranslate()" class="text-slate-400 hover:text-red-500 transition-colors">
        <i class="fa-solid fa-xmark text-lg"></i>
      </button>
    </div>

    <div class="space-y-3">
      <div>
        <textarea id="sourceText" rows="2"
          class="w-full p-2 rounded-lg border border-slate-200 bg-slate-50 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none"
          placeholder="Nhập câu tiếng Anh... (VD: Hello world)"></textarea>
      </div>

      <button onclick="doTranslate()"
        class="w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold py-1.5 rounded-lg text-sm transition-colors flex justify-center items-center gap-2">
        <span>Dịch ngay</span> <i class="fa-solid fa-arrow-right text-xs"></i>
      </button>

      <div class="relative">
        <div class="absolute -top-2 left-2 bg-white px-1 text-[10px] text-slate-400 uppercase font-bold">Kết quả</div>
        <div id="translatedResult"
          class="w-full p-3 rounded-lg border border-slate-200 bg-white text-sm min-h-[60px] text-slate-600 italic">
          ...
        </div>
      </div>
    </div>
  </div>

  <button onclick="toggleTranslate()"
    class="fixed bottom-5 left-5 z-50 w-12 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 active:scale-95 group">
    <i class="fa-solid fa-language text-xl group-hover:rotate-12 transition-transform"></i>
  </button>

  <!-- =========================
    3) JS CŨ: Dịch + Bản đồ/Thời tiết
  ========================== -->
  <script>
    // --- 1. LOGIC DỊCH THUẬT (Translation Logic) ---
    const popup = document.getElementById('translatePopup');
    let isPopupOpen = false;

    function toggleTranslate() {
      isPopupOpen = !isPopupOpen;
      if (isPopupOpen) {
        popup.classList.remove('popup-hidden');
        popup.classList.add('popup-visible');
        document.getElementById('sourceText').focus();
      } else {
        popup.classList.remove('popup-visible');
        popup.classList.add('popup-hidden');
      }
    }

    async function doTranslate() {
      const text = document.getElementById('sourceText').value.trim();
      const resultBox = document.getElementById('translatedResult');

      if (!text) {
        resultBox.textContent = "Vui lòng nhập nội dung để dịch.";
        return;
      }

      resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-indigo-500"></i> Đang dịch...';

      try {
        // Gọi API MyMemory (Miễn phí cho query nhỏ)
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|vi`);
        const data = await res.json();

        if (data.responseData) {
          resultBox.textContent = data.responseData.translatedText;
        } else {
          resultBox.textContent = "Lỗi dịch thuật. Thử lại sau.";
        }
      } catch (e) {
        console.error(e);
        resultBox.textContent = "Không thể kết nối đến máy chủ dịch.";
      }
    }

    // Cho phép ấn Enter trong ô textarea để dịch
    document.getElementById('sourceText').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        doTranslate();
      }
    });

    // --- 2. LOGIC BẢN ĐỒ & THỜI TIẾT (Giữ nguyên logic cũ) ---
    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = d => d * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    const map = L.map('map').setView([16.047, 108.206], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    let originMarker, poiLayer = L.layerGroup().addTo(map);
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('poiList');

    async function geocode(place) {
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('q', place);
      url.searchParams.set('format', 'json');
      url.searchParams.set('limit', '1');
      url.searchParams.set('countrycodes', 'vn');
      const res = await fetch(url);
      const data = await res.json();
      return data[0];
    }

    async function fetchPOIs(lat, lon, radius) {
      const query = `[out:json];(node(around:${radius},${lat},${lon})[amenity];node(around:${radius},${lat},${lon})[tourism];);out body;`;
      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST', body: new URLSearchParams({ data: query })
      });
      const json = await res.json();
      return json.elements.filter(e => e.type === 'node');
    }

    function renderPOIs(origin, nodes) {
      const enriched = nodes.map(n => ({
        ...n, distance: haversine(origin.lat, origin.lon, n.lat, n.lon)
      })).sort((a, b) => a.distance - b.distance).slice(0, 5);

      poiLayer.clearLayers();
      listEl.innerHTML = '';
      if (originMarker) originMarker.remove();
      originMarker = L.marker([origin.lat, origin.lon]).addTo(map).bindPopup(`<b>${origin.display_name}</b>`);
      const bounds = L.latLngBounds([[origin.lat, origin.lon]]);

      enriched.forEach((e, i) => {
        const name = e.tags.name || e.tags['name:vi'] || `Địa điểm #${i + 1}`;
        const type = e.tags.amenity || e.tags.tourism || 'POI';
        const dist = (e.distance / 1000).toFixed(2) + ' km';

        const m = L.marker([e.lat, e.lon]).addTo(map)
          .bindPopup(`<b>${name}</b><br>${type}<br>${dist}`);
        poiLayer.addLayer(m);
        bounds.extend([e.lat, e.lon]);

        const li = document.createElement('li');
        li.className = "p-2 hover:bg-slate-50 rounded cursor-pointer transition-colors border-b border-slate-50 last:border-0";
        li.innerHTML = `<div class="font-medium text-indigo-700">${name}</div><div class="text-xs text-slate-500">${type} • ${dist}</div>`;
        li.onclick = () => { map.panTo([e.lat, e.lon]); m.openPopup(); };
        listEl.appendChild(li);
      });

      if (enriched.length) map.fitBounds(bounds.pad(0.2));
    }

    async function showWeather(lat, lon, placeName) {
      try {
        const apiKey = "43b9608ffa211408507384378f0f374d";
        const url = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=vi`)}`;
        const w = await (await fetch(url)).json();
        const iconUrl = `https://openweathermap.org/img/wn/${w.weather[0].icon}@2x.png`;

        const html = `
          <div class="flex items-center gap-4">
            <img src="${iconUrl}" class="w-16 h-16 drop-shadow-sm filter">
            <div>
              <div class="font-bold text-indigo-700 text-lg">${placeName}</div>
              <div class="text-2xl font-light text-slate-800">${w.main.temp.toFixed(1)}°C</div>
              <div class="text-sm text-slate-500 capitalize">${w.weather[0].description} • Ẩm: ${w.main.humidity}%</div>
            </div>
          </div>
        `;
        let box = document.getElementById('weatherBox');
        if (!box) {
          box = document.createElement('div');
          box.id = 'weatherBox';
          box.className = "mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-indigo-100 rounded-2xl p-4 shadow-sm";
          document.querySelector('main').insertBefore(box, document.getElementById('map'));
        }
        box.innerHTML = html;
      } catch (e) { console.error(e); }
    }

    async function handleSearch() {
      const place = document.getElementById('place').value.trim();
      const radius = +document.getElementById('radius').value;
      if (!place) return alert('Vui lòng nhập tên địa điểm.');

      const btn = document.getElementById('searchBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      statusEl.textContent = 'Đang tìm kiếm...';

      try {
        const geo = await geocode(place);
        if (!geo) throw new Error('Không tìm thấy');

        const lat = +geo.lat, lon = +geo.lon;
        map.setView([lat, lon], 15);
        const pois = await fetchPOIs(lat, lon, radius);
        renderPOIs({ lat, lon, display_name: geo.display_name }, pois);
        await showWeather(lat, lon, geo.display_name);
        statusEl.textContent = 'Đã tìm thấy ' + pois.length + ' địa điểm.';
      } catch (e) {
        statusEl.textContent = 'Không tìm thấy địa điểm hoặc lỗi mạng.';
      } finally {
        btn.innerHTML = originalText;
      }
    }

    document.getElementById('searchBtn').onclick = handleSearch;
    document.getElementById('place').addEventListener('keydown', e => { if (e.key === 'Enter') handleSearch(); });
  </script>

  <!-- =========================
    4) FIREBASE AUTH LOGIC (MỚI) - CDN ES Modules
    - Dán firebaseConfig của bạn vào đây
    - Xem docs: Firebase "Alternative ways to add Firebase" (CDN)
  ========================== -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js';
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      sendEmailVerification,
      sendPasswordResetEmail,
      GoogleAuthProvider,
      signInWithPopup,
    } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js';

    // 1) TODO: THAY firebaseConfig BẰNG CẤU HÌNH THẬT (Firebase Console → Project settings → General → Web app)
    const firebaseConfig = {
      apiKey: "AIzaSyAC_ESkwsCcIObTyWNUm_Z5FObIRhOO7LE",
      authDomain: "tdtt-45517.firebaseapp.com",
      projectId: "tdtt-45517",
      storageBucket: "tdtt-45517.firebasestorage.app",
      messagingSenderId: "609125091306",
      appId: "1:609125091306:web:cbe975f1e7123b6ca19493",
      measurementId: "G-0PPPDV0QXD"
    };

    // 2) Init Firebase
    const app = initializeApp(firebaseConfig);
    // Analytics là tuỳ chọn. Nếu chạy trên môi trường không hỗ trợ (ví dụ mở file trực tiếp file://), dòng này có thể lỗi.
    // Vì vậy mình bọc try/catch để web vẫn chạy bình thường.
    try { getAnalytics(app); } catch (e) { /* ignore */ }

    const auth = getAuth(app);

    // 3) DOM
    const $ = (id) => document.getElementById(id);

    const authLoggedOut = $('authLoggedOut');
    const authLoggedIn = $('authLoggedIn');

    const authEmail = $('authEmail');
    const authPass = $('authPass');

    const loginBtn = $('loginBtn');
    const signupBtn = $('signupBtn');
    const logoutBtn = $('logoutBtn');
    const verifyBtn = $('verifyBtn');
    const resetBtn = $('resetBtn');
    const googleBtn = $('googleBtn');

    const authStatusOut = $('authStatusOut');
    const authStatusIn = $('authStatusIn');

    const userEmailLabel = $('userEmailLabel');
    const emailVerifiedLabel = $('emailVerifiedLabel');
    const headerUserLabel = $('headerUserLabel');

    // 4) Helpers
    function setStatus(el, msg, type = 'info') {
      el.textContent = msg || '';
      el.className = 'text-sm italic ' + (type === 'success'
        ? 'text-emerald-600'
        : type === 'error'
          ? 'text-rose-600'
          : 'text-slate-500');
    }

    function humanizeAuthError(err) {
      const code = err?.code || '';
      switch (code) {
        case 'auth/invalid-email': return 'Email không hợp lệ.';
        case 'auth/email-already-in-use': return 'Email đã được sử dụng. Hãy đăng nhập hoặc dùng email khác.';
        case 'auth/weak-password': return 'Mật khẩu quá yếu (Firebase yêu cầu tối thiểu 6 ký tự).';
        case 'auth/user-not-found': return 'Không tìm thấy tài khoản với email này.';
        case 'auth/wrong-password': return 'Sai mật khẩu.';
        case 'auth/too-many-requests': return 'Bạn thử quá nhiều lần. Hãy đợi một chút rồi thử lại.';
        case 'auth/network-request-failed': return 'Lỗi mạng. Kiểm tra kết nối Internet.';
        case 'auth/popup-closed-by-user': return 'Bạn đã đóng cửa sổ đăng nhập Google.';
        case 'auth/unauthorized-domain': return 'Domain chưa được cấp quyền. Thêm domain vào Authorized domains trong Firebase Console.';
        default: return err?.message || 'Có lỗi xảy ra.';
      }
    }

    function setAppEnabled(enabled) {
      const ids = ['place', 'radius', 'searchBtn'];
      ids.forEach(id => {
        const el = $(id);
        if (!el) return;
        el.disabled = !enabled;
      });

      const statusEl = $('status');
      if (statusEl) {
        statusEl.textContent = enabled ? '' : 'Vui lòng đăng nhập để sử dụng chức năng tìm POI.';
      }
    }

    function clearOutMessages() {
      setStatus(authStatusOut, '');
      setStatus(authStatusIn, '');
    }

    // 5) Actions
    async function doSignUp() {
      clearOutMessages();

      const email = authEmail.value.trim();
      const password = authPass.value;

      if (!email || !password) {
        setStatus(authStatusOut, 'Vui lòng nhập email và mật khẩu.', 'error');
        return;
      }

      try {
        signupBtn.disabled = true;
        signupBtn.classList.add('opacity-50');

        const cred = await createUserWithEmailAndPassword(auth, email, password);

        // (Tuỳ chọn) Gửi email xác minh ngay sau khi đăng ký
        await sendEmailVerification(cred.user);

        setStatus(authStatusIn, 'Đăng ký thành công! Đã gửi email xác minh (hãy kiểm tra Inbox/Spam).', 'success');
      } catch (e) {
        setStatus(authStatusOut, humanizeAuthError(e), 'error');
      } finally {
        signupBtn.disabled = false;
        signupBtn.classList.remove('opacity-50');
      }
    }

    async function doSignIn() {
      clearOutMessages();

      const email = authEmail.value.trim();
      const password = authPass.value;

      if (!email || !password) {
        setStatus(authStatusOut, 'Vui lòng nhập email và mật khẩu.', 'error');
        return;
      }

      try {
        loginBtn.disabled = true;
        loginBtn.classList.add('opacity-50');

        await signInWithEmailAndPassword(auth, email, password);
        setStatus(authStatusIn, 'Đăng nhập thành công!', 'success');
      } catch (e) {
        setStatus(authStatusOut, humanizeAuthError(e), 'error');
      } finally {
        loginBtn.disabled = false;
        loginBtn.classList.remove('opacity-50');
      }
    }

    async function doSignOut() {
      clearOutMessages();
      try {
        await signOut(auth);
        setStatus(authStatusOut, 'Bạn đã đăng xuất.', 'success');
      } catch (e) {
        setStatus(authStatusIn, humanizeAuthError(e), 'error');
      }
    }

    async function doSendVerify() {
      clearOutMessages();
      if (!auth.currentUser) return;

      try {
        verifyBtn.disabled = true;
        verifyBtn.classList.add('opacity-50');

        await sendEmailVerification(auth.currentUser);
        setStatus(authStatusIn, 'Đã gửi lại email xác minh. Hãy kiểm tra Inbox/Spam.', 'success');
      } catch (e) {
        setStatus(authStatusIn, humanizeAuthError(e), 'error');
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.classList.remove('opacity-50');
      }
    }

    async function doResetPassword() {
      clearOutMessages();

      const email = authEmail.value.trim();
      if (!email) {
        setStatus(authStatusOut, 'Nhập email trước, rồi bấm "Quên mật khẩu".', 'error');
        return;
      }

      try {
        resetBtn.disabled = true;
        resetBtn.classList.add('opacity-50');

        await sendPasswordResetEmail(auth, email);
        setStatus(authStatusOut, 'Đã gửi email đặt lại mật khẩu. Hãy kiểm tra Inbox/Spam.', 'success');
      } catch (e) {
        setStatus(authStatusOut, humanizeAuthError(e), 'error');
      } finally {
        resetBtn.disabled = false;
        resetBtn.classList.remove('opacity-50');
      }
    }

    // (Tuỳ chọn) Google sign-in bằng popup
    async function doGoogleSignIn() {
      clearOutMessages();
      try {
        googleBtn.disabled = true;
        googleBtn.classList.add('opacity-50');

        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        setStatus(authStatusIn, 'Đăng nhập Google thành công!', 'success');
      } catch (e) {
        setStatus(authStatusOut, humanizeAuthError(e), 'error');
      } finally {
        googleBtn.disabled = false;
        googleBtn.classList.remove('opacity-50');
      }
    }

    // 6) Bind events
    signupBtn.addEventListener('click', doSignUp);
    loginBtn.addEventListener('click', doSignIn);
    logoutBtn.addEventListener('click', doSignOut);
    verifyBtn.addEventListener('click', doSendVerify);
    resetBtn.addEventListener('click', doResetPassword);
    googleBtn.addEventListener('click', doGoogleSignIn);

    // Enter để đăng nhập nhanh (ở ô password)
    authPass.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSignIn();
    });

    // 7) Auth state observer
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authLoggedOut.classList.add('hidden');
        authLoggedIn.classList.remove('hidden');

        const email = user.email || '(không có email)';
        userEmailLabel.textContent = email;
        headerUserLabel.textContent = email;

        // Hiển thị trạng thái verify
        if (user.emailVerified) {
          emailVerifiedLabel.textContent = '✅ Email đã xác minh';
          verifyBtn.classList.add('hidden');
        } else {
          emailVerifiedLabel.textContent = '⚠️ Email chưa xác minh (khuyến nghị xác minh)';
          verifyBtn.classList.remove('hidden');
        }

        // Mở khoá tính năng tìm POI
        setAppEnabled(true);

        // Nếu bạn muốn CHỈ cho phép tìm POI khi email đã verify:
        // setAppEnabled(!!user.emailVerified);

      } else {
        authLoggedOut.classList.remove('hidden');
        authLoggedIn.classList.add('hidden');

        headerUserLabel.textContent = 'Chưa đăng nhập';
        setAppEnabled(false);
      }
    });
  </script>

</body>
</html>
